//jscs:disable
var raw =  [null,null,null,null,null,null,-102.56366673447282,-99.09082423277361,-149.67090362074413,-145.4314195385071,-161.3688152413999,-159.82671658659825,-138.61445734292485,-143.89220052089703,-152.89130389039494,-144.6812367293789,-120.2190542467735,-132.51860535237736,-131.145331118405,-157.36828376505483,-135.2952373020826,-123.46563843016824,-135.88397502082566,-136.9155707954695,-150.23193481325754,-132.88077324365588,-151.32553599711693,-156.35395687589272,-166.1085542921114,-158.91771100547626,-133.13980049910361,-129.93391971447244,-147.2238525005306,-143.6350680221452,-123.75469225687867,-140.11556358479237,-122.97270401590518,-113.07561991771195,-112.69364508084581,-129.23530744198698,-136.2587363588488,-156.05790505996922,-148.12778103663274,-141.49435847706135,-121.44237841359703,-160.3882681155122,-151.96465009296847,-133.55079930019022,-135.64787459390195,-155.17837494974196,-157.9997921270336,-149.72730613799592,-151.11154925261502,-137.90002789121104,-140.3486150828096,-144.81582760878948,-155.39964432424276,-142.18268110461315,-145.5363889929828,-157.99720133758464,-148.35168960132103,-152.83996264631898,-155.46323209248595,-161.12246993970732,-153.14007686886998,-138.32892806757138,-146.4067178455551,-167.23778717244,-153.92862829824196,-180.2271600360302,-137.4135939197548,-167.00039462951594,-103.7517143285419,-151.20966841915222,-151.90793429125168,-132.96912146906467,-161.34513670463886,-153.2272680535132,17.074228708586375,42.878168097928715,28.763314707497337,40.19998877830577,43.19879109226412,45.598598335597835,48.655333407181196,50.319804314813545,50.64522780374111,50.44204892799183,50.21583028853796,49.9625156955351,49.98087229358526,49.851964847638996,49.81078000434423,49.754425945585155,49.7078018070558,49.520552579676,49.28131411880584,48.959651783969626,48.38899837570033,47.770463110402225,47.31147864996559,45.97467675124956,15.831853090614501,6.325270042194726,5.155570007018189,30.645791084618324,45.73321446030437,10.563106334271843,7.902085740555517,3.128630770750153,7.865753333740894,7.007454782177804,29.637927849666102,45.75458891494889,10.225907490954668,31.15292716914717,46.15899115040964,12.87650773529904,7.445336279713917,2.7369010350674894,31.4942242406223,47.79593323469349,44.54749835399901,28.494545281359137,48.020718862260466,9.206048378463787,32.11858127790695,47.19404426011544,12.1281290591181,32.525962634794304,47.249747543294234,11.757595460806897,10.944289396529674,3.011050526630314,10.815686390521204,7.218092662772726,31.218931815481398,45.58921910047225,28.290123827413993,46.14796981872562,8.164358783594789,31.94423898011165,48.21715280511316,44.57630493697288,28.16152523243856,49.55657952506624,46.114968827117764,5.906518476621342,14.67589326325827,7.828164446974006,32.97858493646198,48.17097609415042,28.216189224779676,49.9416803629627,47.3037175310249,25.806682128072115,49.611877531596164,45.67864168339477,26.804286121984944,48.55080531525144,-5.495413505399639,31.46286239439401,47.88751827928186,-18.018090628417724,11.542213327069247,3.0906688718168738,9.063180964138,20.528360505019233,46.414427225954036,46.27496263030733,45.4910818633942,44.18977040807412,43.92502503363992,44.25356749002589,44.61476229677465,44.393478319187665,43.992264617173184,44.639988602828154,45.797256663748726,46.51868144302777,46.580829239980545,46.45112571614761,46.54650458551472,46.35480003320369,45.623223896290156,44.73291194499378,44.133323394440616,43.32569510829685,42.27816029456004,41.389340889067526,38.76012578897245,-7.4512402799671085,0.3177881708378294,-27.694731432956313,-50.4709652524408,-73.02287711305273,-83.84545135610679,-82.16973759979834,-90.62703532159287,-118.33556686139087,-122.20369370016444,-124.04369481560325,-159.00099146030112,-145.92656535392473,-145.94978732424613,-147.3929850192597,-147.4777399329641,-146.3329475111054,-155.2535255943666,-145.77434128724937,-161.05134705509104,-150.92186091429176,-157.33543676386515,-168.89430556284202,-147.37824226353302,-182.47619051699306,-171.53159394632866,-158.29410476759753,-162.64809191724694,-159.06139129834253,-177.8571206649465,-159.52471196473903,-162.95528795499834,-179.3099303518059,-176.4186031145125,-161.49900906820898,-170.666469250155,-110.3733253375737,-141.93562529782187,-159.83837808246233,-158.49260719482004];

raw = [null,null,null,null,null,-90.84534981178807,-96.20644582123612,-116.28584482659681,-105.25669132760085,-127.53827195773944,-134.96509415982726,-117.15493596513568,-113.89107995250605,-117.59014471580274,-102.6848785888563,-107.70596538630058,-140.15084546987106,-129.3562151154943,-121.20904295615476,-105.28863305851993,-127.87570393504544,-123.72821126085279,-137.59662563122345,-122.591948439979,-108.0217724476145,-120.65440534940727,-131.81288232819477,-138.34562913270415,-124.8030474718521,-127.98607854630129,-115.23985470681046,-93.64975854917888,-121.86641923413497,-117.71614440600237,-127.67255680427498,-145.97364405652064,-134.8947636991972,-112.76254719038215,-128.11826976018654,-125.7569259949746,-121.62918350386214,-127.96485138139312,-158.28545287201126,-102.36686741476132,-145.70976173386615,-148.70150569827067,-126.00722367780321,-111.86675296114123,-105.16582208954986,23.757693310334528,39.28853878993256,34.10251146007003,36.273130903428005,37.67242843779473,37.09862448890587,38.89998522236934,37.61643486425839,38.04736619013375,37.56114764733926,37.986282713624306,38.11140647648514,38.33378279076768,38.07015100199865,38.028448446535926,38.04286918775984,38.11536820296905,38.05680251326589,38.06312362819516,37.949692904435736,37.90248349651027,37.86741372717913,37.73826907424522,34.55813797527877,-7.9095359203087305,-49.64259826991941,0.9683390304052402,31.876751547040296,-5.235868247372833,-6.601800547790599,31.586629491026947,-7.72996626563814,-17.524043811713376,-5.948953986814688,-0.04310101414304718,37.04660428635451,32.38217058449575,0.3744431819129491,34.4777173894469,-28.225871997107433,1.303839424412273,30.499355808102607,-13.692684732682597,-3.396864902067631,30.625921517474282,-9.565578288340532,-14.309148170455423,-8.392822849873014,-6.281815883056863,-15.06505079941313,5.438372422384127,33.49991717530161,-3.5369522311623784,-13.096155465299933,-3.696353665391596,36.25826905919766,33.65876685075756,-10.06985025510275,11.414769997725912,37.36081575134725,33.46098751922637,-10.169821268861309,-31.993373992957054,-16.144170013700595,2.5414210873111327,34.67827637683349,1.3461537322059525,37.193511023061994,34.97732148714674,-25.71948728943532,-26.52048977665793,4.541791134097012,32.984002908329614,-4.564536705133739,4.593034843605458,36.75924219010461,34.30112640000746,-3.465101047686796,34.14866322470817,-33.93199437602715,5.638233681554573,31.712151255668367,4.800475579519185,36.3226340116226,34.134730506533636,-19.76373273806765,-19.68868412009947,-22.094681542638355,-7.750213825620552,25.759450490247147,-23.332417834558555,29.188953958701344,32.693390095896156,1.1183721907070596,33.321597251806324,36.612025380569555,33.2364430415827,-16.475806034696628,-27.135738361079092,-17.24052104330287,21.750626390875837,-13.813835586677865,-12.902191325729,-22.16677679251438,-12.8710865854224,-14.138274059389815,29.38737303638383,32.26352075730545,33.52793108784073,34.918034629031546,34.54430987743811,34.82307051357393,34.356856689704934,34.03649189536545,34.05858349754675,33.78751948323452,33.822094253875136,33.86465416443875,33.596264710851315,33.34977270863082,33.15267297404265,33.128647379967894,32.99647995234625,32.89472150536312,32.99830206287817,33.30358014210479,33.45734106895812,33.43994486950984,31.449442305293665,-7.156742661326481,-20.398015056016725,-39.90582428495912,-71.09038294300915,-88.43951618551375,-76.70531837311447,-95.64786404203244,-79.86661789463304,-89.80006937112623,-87.97050335340523,-91.50377839308675,-94.1166777458753,-108.87677883933632,-139.95910351660444,-134.62446389116647,-129.0867771992215,-123.75586413734902,-131.68699427677748,-119.56341496099755,-123.13988658396723,-153.09723976543603,-124.92778281123668,-159.2705805138815,-116.90901633162967,-130.78740033240672,-126.7345401500851]

raw = [null,null,null,-109.33212252864699,-131.87443543733988,-118.90165824374662,-115.08215599920493,-116.6482371507554,-114.2988107449155,-107.13564090737944,-108.0037271203559,-105.72525576423166,-108.09361237021318,-103.33815075304645,-97.36052734458278,-117.20022603369682,-132.33755359486787,-117.33958969084688,-107.12188477521852,-111.76273530257676,-116.89067817535232,-137.01881874916464,-102.42584668643921,-91.67711694231829,-89.48360256627353,-114.97050412979382,-94.08011483808733,-115.32908416031563,-104.48492796517328,-123.8026499596503,-153.4951826740144,-101.75891997421678,-137.6991991662862,-111.42574197186825,-119.59488032154195,-107.4628783478293,-89.50488416210271,-85.9486946855205,-83.31686860203534,-99.04584778538867,-126.8147152419205,-122.839105695776,-109.93446210581479,-111.62572426889221,-135.2418534097167,-144.1508495395745,-115.50883781103283,-115.24369709913012,-124.10098515930775,-126.25125247202209,-135.68695351299138,-121.91810348119112,-108.78132632485199,-122.53065415434426,-124.96619681794357,-127.26600818574795,-111.42415019984645,-119.21456705558361,-123.45124546581353,-132.72439762588266,-113.93423897374402,-146.49781332087002,-127.30232522997979,-127.13846789985085,-108.85938020340666,-139.67002697502903,-118.96935001842581,-118.46069432555842,-116.70278475712539,-127.63042130561644,-108.68405666599165,-117.50017494928906,-137.64041880500622,-130.23705138787807,-145.66944756493874,-118.19578606616317,-106.2555599587418,-106.15500208510787,-120.38358516551833,-154.84243526358023,-135.07119197854365,-118.43975879502983,-141.48455862006563,-111.8076118283448,-115.91723340509922,-133.53514717309383,-133.37223712443435,-138.4688879386822,-131.13705323295721,-142.4575859279381,-121.84259419119448,-152.1151308604224,-145.12217193142914,-140.55905496814307,-118.85826697864383,-129.64244975171297,-135.06160237300836,-147.83328570185347,-136.74968105501625,-143.23470407532724,-152.40541750923012,-148.70438793190405,-128.91328537954246,-132.89724161134944,-133.69637303600905,-145.9749335585965,-121.12351608480218,-123.2382853807111,-112.88134696032627,-133.59464150473735,-156.88521348270265,-132.16889987679514,-132.5758960452598,-131.5359396519092,-123.42839000219058,-117.5744860514837,-119.06475482536351,-104.43567607609234,-130.44046792995033,-133.3575845351349,-136.80950319422647,-169.37704450982193,-140.98308392763673,-134.4578600446886,-137.29956506882266,-119.08777140685419,-152.0306241345674,-129.40398816379033,-116.48404833144555,-167.92008489492162,-124.27048137522652,-139.26133346185628,-142.78979612378137,-126.72369771249737,-96.71358037441074,-110.88066016001653,-116.6837211140575,-91.3847709984695,-134.24924334671354,-103.2776931716618,-118.84706163461884,-115.2188025363391,-92.55079466505222,-113.91267676621673,-95.30409625094947,49.686034731548915,38.11161473056805,41.95489561978441,42.42375715308302,42.96970939409293,42.25322217544979,41.34714385235462,42.651336150979304,41.5672139955942,41.23499832401144,41.70885979758519,41.760148901538685,41.68799244165467,41.83426805061895,41.79858154937625,41.920361071873145,41.78499630397846,41.616872785132124,41.61744030724593,41.60062005709052,41.448950845887545,41.51156590224456,41.404754103084855,22.839088344089152,-6.778127410961644,-3.055934152709927,38.58837419953041,19.242643643719795,-13.217214686757803,39.49078925643269,20.00787576966317,-7.372498288940747,-4.348807131412788,-18.076504619996243,38.919967442068554,39.9839442290257,21.258743635596353,39.32779208713953,19.19788397125165,-9.878267376034437,39.633609977659134,18.714477169673632,-15.683786679827051,38.5517156723897,20.461403458913555,-12.004264370039987,-4.350369348836363,-18.086385091276533,-16.332350451396035,-19.396292629706075,38.61542209715826,19.337162552822974,-10.119391564968474,38.50625593947116,18.083051223244272,38.44404004980407,18.501592220260587,-15.653819593766904,38.628400160649484,17.454373748486,38.75930860259619,17.629658702088815,-12.898981284003266,38.599757981460016,39.711580717997066,18.688807855647735,39.355491031348244,18.429167024585446,-7.311117948655888,-2.884755393917848,-27.125918035138653,38.99990927484915,39.39235558165564,19.1783958089883,38.80437933680658,17.12676725535018,-6.889373909979064,38.87211973852156,38.61424715029101,39.0588185661569,40.09165638845742,19.23082763044546,39.45835362220325,19.111667346017708,-9.814663266656739,37.71923346551619,37.19102926825106,37.43123776877253,16.447592723481023,-7.061775976887288,36.03967251587736,17.63714997118331,-13.20074085058712,-11.071804366983205,35.80072520079021,36.022560467064636,10.107935416950717,-46.7738346740321,-10.340964332949437,35.06124154491383,12.1995651816414,-28.221347291221335,-17.626713436974477,-15.641950036068994,-16.68380883411924,33.37415915463839,34.27701813341281,33.16100943574025,34.0247502310344,33.75733123929973,32.82191814586555,32.35760840431127,33.2882724796952,33.206860835537555,33.5995570354898,33.59805263778657,33.30982270205225,33.48991655822588,33.61541947324409,33.38951617331694,33.037800594608285,33.086571668562115,33.24610473749969,33.42070202951828,33.19435469235083,32.98723715277829,33.04708696839147,33.64960486150248,7.323803791596728,-33.37339518847755,-26.189350070297802,-40.076088977552104,-42.39499328481357,-72.88430956452824,-64.20377195453392,-85.72883667446818,-103.13940271695486,-97.1459899209602,-125.70719431586338,-103.31862467889263,-97.48662850105319,-120.90162178659513,-112.07006939408794,-123.57002692216005,-129.1855870201569,-132.36111507761825,-131.62539516989497,-113.35105022202434,-136.18749640848924,-122.13355398003726,-141.6103329458689,-134.52283094638406,-116.77845574853272,-119.62547229393985,-117.7825559093558,-132.56345468352663,-144.87759870232193,-110.8357541224868,-124.53781760832445,-154.20547903500218,-127.70229114479334,-123.74146884443601,-130.25086342689247,-121.94265429431843,-128.2325324820484,-147.70603560550296,-122.3269083729052,-121.05315573783854,-109.9847771122591,-137.9417349470705,-131.72613288151732,-129.97663145078405,-140.97600965596374,-109.09163562459543,-136.1948354182365,-132.78934161337875,-141.6865905923226,-127.89268914193212,-150.07139547702639,-140.1093293060259,-125.16531500378466,-156.86426163057405,-127.10727466806239,-151.99687997180246,-124.10113596058976,-118.88016721287502,-135.04833894469056,-137.6784144246505,-162.8386700959649,-111.94833439008903,-118.87826022141327,-137.82534494208605,-127.5794535522276,-123.74928990421607,-150.6133665283118,-128.03000799310172,-119.18647840768915,-153.47921921793966,-142.5934241526575,-115.49861772932401,-132.08838971421136,-114.98650824184759,-136.10018661153015]
//jscs:enable

var rawGraph = document.createElement('canvas');
var rawHeight = 100;
var rawWidth = 600;
rawGraph.setAttribute('height', rawHeight + 'px');
rawGraph.setAttribute('width', rawWidth + 'px');
var rawCtx = rawGraph.getContext('2d');

raw = raw
.filter(function(v) {
  return v !== null && v !== -Infinity;
});

var rawMin = _.min(raw);

raw = raw.map(function(v) {
  // 0 out min
  return v -= rawMin;
});

var rawMax = _.max(raw);

raw = raw
.map(function(v) {
  // Normalize to 0 - 1
  return v / rawMax;
});

raw.forEach(function(v, i) {
  rawCtx.fillRect(i * rawWidth / raw.length, v * rawHeight * 0.95 , 5 , 5);
});

document.body.appendChild(rawGraph);

var movingAverageGraph = document.createElement('canvas');
movingAverageGraph.setAttribute('height', rawHeight + 'px');
movingAverageGraph.setAttribute('width', rawWidth + 'px');
var movingAverageCtx = movingAverageGraph.getContext('2d');
var movingAverageWindow = 20;

movingAverage = raw
.map(function(v, i, arr) {
  for (var j = 0; j < movingAverageWindow && arr[i + j] !== undefined; ++j) {
    v += arr[i + j];
  }
  return v *= 1 / movingAverageWindow;
});

var movingAverageMin = _.min(movingAverage);

movingAverage = movingAverage.map(function(v) {
  return v - movingAverageMin;
});

var movingAverageMax = _.max(movingAverage);

movingAverage = movingAverage.map(function(v) {
  return v / movingAverageMax;
});

movingAverage.forEach(function(v, i) {
  movingAverageCtx.fillRect(i * rawWidth / movingAverage.length, v * rawHeight * 0.95, 5, 5);
});

movingAverageGraph.style.opacity = '0.5';
document.body.appendChild(movingAverageGraph);

var diffGraph = document.createElement('canvas');
diffGraph.setAttribute('height', rawHeight + 'px');
diffGraph.setAttribute('width', rawWidth + 'px');
var diffGraphCtx = diffGraph.getContext('2d');
var diffRange = 40;

diffPoints = movingAverage
.map(function(v, i, arr) {
  return v - _.sum(arr.slice(i, i + diffRange)) / diffRange;
});

var minDiff = _.min(diffPoints);

diffPoints = diffPoints
.map(function(v) {
  return v -= minDiff;
});

var maxDiff = _.max(diffPoints);

diffPoints = diffPoints
.map(function(v) {
  return v / maxDiff;
});

var maxChange = _.max(diffPoints);
var minChange = _.min(diffPoints);
diffPoints
.forEach(function(v, i) {
  diffGraphCtx.fillStyle = 'black';

  if (v == minChange) {
    diffGraphCtx.fillStyle = 'red';
  }

  if (v == maxChange) {
    diffGraphCtx.fillStyle = 'orange';
  }

  diffGraphCtx.fillRect(i * rawWidth / diffPoints.length, v * rawHeight * 0.95, 5, 5);
});

document.body.appendChild(diffGraph);

var dataGraph = document.createElement('canvas');
dataGraph.setAttribute('height', rawHeight + 'px');
dataGraph.setAttribute('width', rawWidth + 'px');
var dataGraphCtx = dataGraph.getContext('2d');

var dataBits = raw.slice(diffPoints.indexOf(minChange)+diffRange/2, diffPoints.indexOf(maxChange));

var minDataBit = _.min(dataBits);

dataBits = dataBits.map(function(v) {
  return v - minDataBit;
});

var maxDataBit = _.max(dataBits);

dataBits = dataBits.map(function(v) {
  return v / maxDataBit;
});

dataBits.forEach(function(v, i) {
  dataGraphCtx.fillRect(i * rawWidth / dataBits.length, v * rawHeight * 0.95, 5, 5);
});

document.body.appendChild(dataGraph);

var trimmedDataGraph = document.createElement('canvas');
trimmedDataGraph.setAttribute('height', rawHeight + 'px');
trimmedDataGraph.setAttribute('width', rawWidth + 'px');
var trimmedDataGraphCtx = trimmedDataGraph.getContext('2d');

// this needs work
function trimLeading(data) {
  var highFound = false;
  var lowFound = 0;
  var trimIndex = -1;
  data.forEach(function(v, i) {
    if (highFound && lowFound < 2 && v < 0.5) {
     if(++lowFound == 2) {
       trimIndex = i;
     }
    }
    if (v > 0.6) {
      highFound = true;
    }
  });

  return data.slice(trimIndex);
}

var trimmedData = trimLeading(trimLeading(dataBits).reverse()).reverse();

var minTrimmedData = _.min(trimmedData);

trimmedData = _.map(trimmedData, function(v) { return v - minTrimmedData });

var maxTrimmedData = _.max(trimmedData);

trimmedData = _.map(trimmedData, function(v) { return v / maxTrimmedData });

var binary = '';

trimmedData.forEach(function(v, i) {
  trimmedDataGraphCtx.fillStyle = v > 0.8 ? "red" : "blue";
  binary += v > 0.8 ? "1" : "0";
  trimmedDataGraphCtx.fillRect(i * rawWidth / trimmedData.length, v * rawHeight * 0.95, 5, 5);
});
console.log(binary);
console.log(require('binary-to-string')(binary));
document.body.appendChild(trimmedDataGraph);
